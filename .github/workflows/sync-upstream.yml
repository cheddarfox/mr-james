name: Sync Upstream Template

on:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sundays at midnight UTC
  workflow_dispatch:      # Allow manual trigger

jobs:
  sync:
    name: Check for Template Updates
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get upstream URL
        id: upstream
        run: |
          if [ -f ".wtfb/project.json" ]; then
            UPSTREAM=$(jq -r '.template.upstream // empty' .wtfb/project.json)
            if [ -n "$UPSTREAM" ]; then
              echo "url=$UPSTREAM" >> $GITHUB_OUTPUT
              echo "Upstream template: $UPSTREAM"
            else
              echo "No upstream template configured"
              exit 0
            fi
          else
            echo "No project.json found"
            exit 0
          fi

      - name: Add upstream remote
        if: steps.upstream.outputs.url != ''
        run: |
          git remote add upstream ${{ steps.upstream.outputs.url }} || true
          git fetch upstream main

      - name: Check for updates
        id: check
        if: steps.upstream.outputs.url != ''
        run: |
          BEHIND=$(git rev-list HEAD..upstream/main --count 2>/dev/null || echo "0")
          echo "behind=$BEHIND" >> $GITHUB_OUTPUT
          echo "Commits behind upstream: $BEHIND"

      - name: Get sync paths
        id: paths
        if: steps.check.outputs.behind > 0
        run: |
          SYNC_PATHS=$(jq -r '.syncPaths[]? // empty' .wtfb/project.json | tr '\n' ' ')
          echo "paths=$SYNC_PATHS" >> $GITHUB_OUTPUT
          echo "Sync paths: $SYNC_PATHS"

      - name: Create sync branch
        if: steps.check.outputs.behind > 0
        run: |
          git checkout -b sync/upstream-template-$(date +%Y%m%d)

          # Cherry-pick changes only for syncPaths
          # This is a simplified approach - full implementation would filter by path
          git merge upstream/main --no-commit --no-ff || true

          # Check for conflicts
          if git diff --name-only --diff-filter=U | grep -q .; then
            echo "Conflicts detected - manual resolution required"
            git merge --abort
            exit 1
          fi

          git commit -m "sync: merge upstream template updates" || echo "No changes to commit"

      - name: Create Pull Request
        if: steps.check.outputs.behind > 0
        uses: peter-evans/create-pull-request@v5
        with:
          title: 'sync: Update from upstream template'
          body: |
            ## Template Update Available

            This PR syncs changes from the WTFB projects template.

            **Upstream:** ${{ steps.upstream.outputs.url }}
            **Commits behind:** ${{ steps.check.outputs.behind }}

            ### Sync Paths (will be updated)
            ```
            ${{ steps.paths.outputs.paths }}
            ```

            ### Protected Paths (will NOT be changed)
            Check `.wtfb/project.json` for the full list of protected paths.

            ### Review Checklist
            - [ ] CI/CD workflow updates are compatible
            - [ ] Validation script improvements work with our content
            - [ ] New template features are useful
            - [ ] No conflicts with custom content

            ---
            *Auto-generated by sync-upstream workflow*
          branch: sync/upstream-template
          base: main
          labels: |
            sync
            template-update
